<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Papeletas - Cirineo</title>
    
    <link rel="icon" href="https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/CIRINEO/refs/heads/main/icon.ico">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Roboto+Condensed:wght@400&display=swap" rel="stylesheet">

    <style>
        body { background-color: #f1f5f9; color: #1e293b; font-family: system-ui, -apple-system, sans-serif; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
        .card-enter { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Estilos específicos de las papeletas */
        @page { size: auto; margin: 0; }
        .label-container { 
            width: 7.5cm; 
            height: 10cm; 
            padding: 0.5cm; 
            border: 1px dashed #aaa;
            margin: 0.5cm; 
            page-break-after: always;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
        }
        .label-wrapper {
            break-inside: avoid;
        }

        /* Ocultar elementos en la impresión */
        @media print {
            body { background: white !important; }
            #header, #sidebar, #scan-tracker { display: none !important; }
            #label-preview { width: 100% !important; margin: 0; padding: 0 !important; }
            .label-container { border: none !important; margin: 0 !important; padding: 0.3cm !important; height: 9.8cm !important; box-shadow: none !important; }
            .label-wrapper { page-break-after: always; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- CONFIGURACIÓN FIREBASE (Misma que todos) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBqHgV4vDat1-VmZfKbiPg7nuiX-ROcexw",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409",
            measurementId: "G-B7YLM78RVW"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- COMPONENTE ICONO ---
        const Icon = ({ name, size = 18, className }) => {
            const containerRef = React.useRef(null);
            React.useEffect(() => {
                if (containerRef.current && lucide.icons[name]) {
                    containerRef.current.innerHTML = lucide.icons[name].toSvg({ width: size, height: size, class: className });
                }
            }, [name, size, className]);
            return <span ref={containerRef} className="inline-flex items-center justify-center"></span>;
        };

        // --- 1. COMPONENTE PAPELETA DE PRODUCCIÓN ---
        const ProductionLabel = ({ labelData }) => {
            const barcodeRef = React.useRef(null);

            useEffect(() => {
                if (barcodeRef.current && labelData.codigo_paquete) {
                    JsBarcode(barcodeRef.current, labelData.codigo_paquete, {
                        format: "CODE128",
                        displayValue: true,
                        fontSize: 14,
                        margin: 5,
                        width: 1.5,
                        height: 50,
                        text: labelData.codigo_paquete
                    });
                }
            }, [labelData.codigo_paquete]);

            return (
                <div className="label-container bg-white flex flex-col justify-between" style={{ fontFamily: "'Roboto Condensed', sans-serif" }}>
                    {/* Header */}
                    <div>
                        <div className="flex justify-between items-center border-b border-gray-300 pb-1 mb-1">
                            <span className="text-xs font-bold text-gray-700">ORDEN: {labelData.orderId}</span>
                            <span className="text-xs font-bold text-gray-700">FECHA IMPRESIÓN: {labelData.fechaImpresion ? labelData.fechaImpresion.split(' ')[0] : '---'}</span>
                        </div>
                        <h1 className="text-xl font-bold uppercase" style={{ fontFamily: "'Oswald', sans-serif", lineHeight: 1 }}>{labelData.modelo}</h1>
                        <p className="text-sm text-indigo-600 font-medium">{labelData.partida}</p>
                    </div>

                    {/* Contenido Central */}
                    <div className="flex-1 my-2 flex flex-col justify-center items-center text-center">
                        <div className="text-4xl font-black text-gray-800" style={{ fontFamily: "'Oswald', sans-serif" }}>
                            {labelData.paqueteNum} / {labelData.totalPaquetes}
                        </div>
                        <span className="text-xs font-bold text-gray-500">PAQUETE NÚMERO</span>
                        <div className="mt-3 bg-gray-100 p-1 rounded">
                            <span className="text-lg font-bold text-gray-700">{labelData.cantidad} PCS</span>
                        </div>
                    </div>

                    {/* Footer y Barcode */}
                    <div className="text-center">
                        <svg ref={barcodeRef} className="w-full h-auto"></svg>
                        <div className="text-[10px] font-mono text-gray-600 mt-1">
                            <span className="font-bold">CÓDIGO:</span> {labelData.codigo_paquete}
                        </div>
                    </div>
                </div>
            );
        };


        // --- 2. COMPONENTE LECTOR / TRACKER ---
        const ScanTracker = ({ allOrders, onScan }) => {
            const [tejedor, setTejedor] = useState('');
            const [scanCode, setScanCode] = useState('');
            const [lastScans, setLastScans] = useState([]);
            const [inputError, setInputError] = useState(null);

            // Cargar últimos escaneos (solo para visualización)
            useEffect(() => {
                const unsubscribe = db.collection('registro_produccion')
                    .orderBy('fecha', 'desc')
                    .limit(5)
                    .onSnapshot(snap => {
                        const data = snap.docs.map(d => ({...d.data(), id: d.id}));
                        setLastScans(data);
                    });
                return () => unsubscribe();
            }, []);

            // Lógica de validación y guardado
            const processScan = useCallback(() => {
                setInputError(null);
                if (!tejedor.trim()) {
                    setInputError("Debe ingresar el nombre del Tejedor.");
                    return;
                }
                if (!scanCode.trim() || !scanCode.includes('-')) {
                    setInputError("Código de paquete inválido.");
                    return;
                }

                const parts = scanCode.split('-');
                if (parts.length < 2) {
                    setInputError("Formato de código incorrecto (Esperado: ID-PaqueteNum).");
                    return;
                }

                const orderId = parts[0];
                const paqueteNum = parseInt(parts[1]);

                // 1. Encontrar la orden correspondiente
                const order = allOrders.find(o => String(o.id) === String(orderId));

                if (!order || order.status === 'ARCHIVADO') {
                    setInputError(`Orden ${orderId} no encontrada o archivada.`);
                    return;
                }

                // 2. Encontrar el paquete dentro de la orden
                const paquete = order.progreso.find(p => p.paqueteNum === paqueteNum);

                if (!paquete) {
                    setInputError(`Paquete #${paqueteNum} no existe en la orden ${orderId}.`);
                    return;
                }

                if (paquete.finished) {
                    setInputError(`¡Advertencia! Paquete #${paqueteNum} ya fue escaneado.`);
                    // Aún permitimos registrar el escaneo duplicado, pero avisamos.
                }

                // 3. Crear los datos de la papeleta (simulando que la etiqueta ya fue generada)
                // Se necesitan todos los campos necesarios para el guardado.
                // Aquí simulamos que obtenemos la fechaImpresion del objeto de progreso de la orden
                // Nota: Si la fechaImpresion se guarda al generar la etiqueta (como en el App Component),
                // esta lógica de extracción debe ser robusta. Usaremos la fecha/hora actual como fallback si no se encuentra.
                const simulatedLabelData = {
                    orderId: order.id,
                    modelo: order.modelo,
                    partida: order.partida,
                    paqueteNum: paquete.paqueteNum,
                    cantidad: paquete.cantidad,
                    totalPaquetes: order.progreso.length,
                    codigo_paquete: scanCode,
                    
                    // *** CAMPO CRÍTICO PARA EL HISTORIAL: Se debe incluir al escanear. ***
                    // Asumiendo que la fecha de impresión se guardó en el objeto de progreso cuando se generó la orden/papeleta.
                    // Si no se guardó, puedes usar una fecha por defecto, pero es menos exacto.
                    fechaImpresion: new Date().toLocaleString('es-ES'), // Usamos la fecha actual como fallback robusto
                };

                // 4. Llamar a la función de guardado
                onScan(scanCode, tejedor, simulatedLabelData);

                // Limpiar después del escaneo exitoso
                setScanCode('');
                setInputError(null);
            }, [tejedor, scanCode, allOrders, onScan]);

            const handleKeyDown = (e) => {
                if (e.key === 'Enter') {
                    processScan();
                }
            };

            return (
                <div id="scan-tracker" className="w-[300px] flex-shrink-0 bg-slate-800 p-4 border-l border-slate-700 flex flex-col overflow-y-auto">
                    <h2 className="text-lg font-black text-white mb-4 border-b border-slate-700 pb-2 flex items-center gap-2">
                        <Icon name="scan" size={20}/> ESCANEO RÁPIDO
                    </h2>
                    
                    <div className="mb-4">
                        <label className="block text-xs font-bold text-slate-400 mb-1">Nombre del Tejedor</label>
                        <input
                            type="text"
                            value={tejedor}
                            onChange={(e) => setTejedor(e.target.value)}
                            className="w-full p-2 bg-slate-700 border border-slate-600 rounded text-sm text-white focus:outline-none focus:border-indigo-500"
                            placeholder="Ej: JUAN PERÉZ"
                        />
                    </div>

                    <div className="mb-4">
                        <label className="block text-xs font-bold text-slate-400 mb-1">CÓDIGO DE PAQUETE</label>
                        <input
                            type="text"
                            value={scanCode}
                            onChange={(e) => setScanCode(e.target.value)}
                            onKeyDown={handleKeyDown}
                            className="w-full p-2 bg-slate-700 border border-slate-600 rounded text-sm text-white font-mono focus:outline-none focus:border-green-500"
                            placeholder="Ej: 123-5"
                            autoFocus
                        />
                        {inputError && <p className="text-red-400 text-xs mt-1 flex items-center gap-1"><Icon name="alert-triangle" size={12}/>{inputError}</p>}
                    </div>

                    <button 
                        onClick={processScan}
                        className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg flex items-center justify-center gap-2 transition"
                    >
                        <Icon name="send" size={16}/> REGISTRAR ESCANEO
                    </button>

                    <div className="mt-6 pt-4 border-t border-slate-700">
                        <h3 className="text-sm font-bold text-slate-300 mb-2">Últimos Escaneos</h3>
                        <div className="space-y-2">
                            {lastScans.map(scan => (
                                <div 
                                    key={scan.id} 
                                    className={`p-2 rounded text-xs flex justify-between items-center ${scan.status === 'PENDING' ? 'bg-yellow-900/50 text-yellow-300' : (scan.status === 'SYNC' ? 'bg-green-900/50 text-green-300' : 'bg-slate-700 text-slate-400')}`}
                                >
                                    <div className="font-mono">{scan.codigo_paquete}</div>
                                    <div className="text-[10px] text-right">
                                        <span className="font-bold block">{scan.tejedor}</span>
                                        <span className={`italic ${scan.status === 'SYNC' ? 'text-green-400' : ''}`}>{scan.status}</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };


        // --- 3. COMPONENTE APP PRINCIPAL ---
        const App = () => {
            const [orders, setOrders] = useState([]);
            const [selectedOrder, setSelectedOrder] = useState(null);
            const [packageLabels, setPackageLabels] = useState([]);
            const [scanTrackerKey, setScanTrackerKey] = useState(0); 

            // Cargar datos de Firebase
            useEffect(() => {
                const unsubscribe = db.collection('orders')
                    .where('status', '!=', 'ARCHIVADO')
                    .onSnapshot(snap => {
                        const data = snap.docs.map(d => ({...d.data(), id: d.id})).sort((a, b) => b.fechaCreacion - a.fechaCreacion);
                        setOrders(data);
                    });
                return () => unsubscribe();
            }, []);

            // Generar las papeletas del paquete seleccionado
            const generateLabels = useCallback((order) => {
                if (!order || !order.progreso) {
                    setPackageLabels([]);
                    return;
                }
                
                const now = new Date().toLocaleString('es-ES', { timeZone: 'America/Mexico_City' }); // Capturar hora de impresión
                
                const labels = order.progreso.map(p => ({
                    orderId: order.id,
                    modelo: order.modelo,
                    partida: order.partida,
                    paqueteNum: p.paqueteNum,
                    cantidad: p.cantidad,
                    totalPaquetes: order.progreso.length,
                    codigo_paquete: `${order.id}-${p.paqueteNum}`,
                    // *** CAMPO CRÍTICO AÑADIDO: Fecha de impresión de la papeleta ***
                    fechaImpresion: now, 
                }));

                setPackageLabels(labels);
            }, []);

            const handleOrderSelect = (order) => {
                setSelectedOrder(order);
                generateLabels(order);
            };

            // FUNCIÓN CENTRAL: GUARDA EL ESCANEO EN LA COLECCIÓN `registro_produccion`
            const handleSuccessfulScan = async (scannedCode, tejedor, labelData) => {
                const now = new Date();
                
                const scanData = {
                    orderId: labelData.orderId,
                    codigo_paquete: scannedCode,
                    tejedor: tejedor.toUpperCase(),
                    paquete_indice: labelData.paqueteNum,
                    paquete_total: labelData.totalPaquetes,
                    modelo: labelData.modelo,
                    partida: labelData.partida,
                    
                    // Fecha de la transacción en Firebase
                    fecha: firebase.firestore.FieldValue.serverTimestamp(),
                    
                    // Hora local del escaneo (para mostrar en el tracker)
                    fecha_scan: now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' }),
                    
                    // *** NUEVOS CAMPOS PARA EL CONSOLIDADOR/HISTORIAL ***
                    status: 'PENDING', // Debe ser revisado por el consolidador
                    fechaImpresion: labelData.fechaImpresion || new Date().toLocaleString('es-ES'), // Usar la fecha de impresión de la etiqueta
                    // ***************************************************
                };

                try {
                    await db.collection('registro_produccion').add(scanData);
                    alert(`Escaneo de ${scannedCode} registrado con éxito. Pendiente de aprobación.`);
                    
                    // Forzar la actualización del ScanTracker para ver el nuevo registro
                    setScanTrackerKey(prev => prev + 1);

                } catch (error) {
                    console.error("Error al registrar escaneo:", error);
                    alert("Error al registrar escaneo: " + error.message);
                }
            };


            return (
                <div className="h-screen flex overflow-hidden bg-slate-100">
                    
                    {/* COLUMNA 1: SIDEBAR / LISTA DE ÓRDENES */}
                    <div id="sidebar" className="w-[300px] flex-shrink-0 bg-white p-4 border-r border-slate-200 overflow-y-auto">
                        <h2 className="text-lg font-black text-slate-800 mb-4 border-b pb-2 flex items-center gap-2">
                            <Icon name="clipboard-list" size={20}/> ÓRDENES ACTIVAS
                        </h2>
                        
                        <div className="space-y-2">
                            {orders.map(o => (
                                <div 
                                    key={o.id}
                                    onClick={() => handleOrderSelect(o)}
                                    className={`p-3 rounded-lg border cursor-pointer transition card-enter 
                                        ${selectedOrder && selectedOrder.id === o.id ? 'bg-indigo-100 border-indigo-400 shadow-md' : 'bg-white border-slate-200 hover:bg-slate-50'}
                                    `}
                                >
                                    <p className="text-sm font-bold text-slate-800 leading-tight">{o.modelo}</p>
                                    <p className="text-xs text-indigo-600 font-medium">{o.partida}</p>
                                    <p className="text-[10px] text-slate-500 mt-1">ID: {o.id} | Total: {o.totalPedido} pzs</p>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* COLUMNA 2: VISUALIZADOR DE PAPELETAS */}
                    <div id="label-preview" className="flex-1 overflow-y-auto p-4 bg-slate-50">
                        <h2 className="text-lg font-black text-slate-800 mb-4 border-b pb-2 flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <Icon name="printer" size={20}/> VISUALIZADOR DE PAPELETAS
                            </div>
                            {packageLabels.length > 0 && (
                                <button 
                                    onClick={() => window.print()}
                                    className="bg-green-600 hover:bg-green-700 text-white text-xs font-bold py-1.5 px-3 rounded-full flex items-center gap-1 transition shadow-md shadow-green-500/30"
                                >
                                    <Icon name="send-to-back" size={14}/> IMPRIMIR {packageLabels.length} PAPELETAS
                                </button>
                            )}
                        </h2>

                        <div className="flex flex-wrap gap-4 justify-start print:block">
                            {packageLabels.length > 0 ? (
                                packageLabels.map((labelData, index) => (
                                    <div key={index} className="label-wrapper">
                                        <ProductionLabel labelData={labelData} />
                                    </div>
                                ))
                            ) : (
                                <div className="text-center text-slate-400 flex flex-col items-center mt-20 w-full">
                                    <Icon name="arrow-left-circle" size={48} className="mb-4 opacity-50"/>
                                    <p className="text-lg font-bold">Selecciona una orden del menú izquierdo</p>
                                    <p className="text-sm">Para generar y visualizar sus papeletas.</p>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* COLUMNA 3: LECTOR / TRACKER (Siempre visible para Escaneo Rápido) */}
                    <ScanTracker 
                        key={scanTrackerKey} 
                        allOrders={orders} 
                        onScan={handleSuccessfulScan}
                    />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>